# cPCH: Powerful Partial Conjunction Hypothesis Testing via Conditioning

Conditional Partial Conjunction Hypothesis (cPCH) testing is a new method for testing a single partial conjunction hypothesis that directly corrects the conservativeness of standard approaches by conditioning on certain order statistics of the base p-values. For details about the methodology, check out our paper: https://arxiv.org/abs/2212.11304

This repository contains the implementation of the cPCH test, a tutorial for its use, and all files for reproducing the results in the paper. It contains following directories and files:

1. `code_tutorial.ipynb`: an IPython Notebook containing a tutorial for running a single cPCH test (and corresponding t-distribution versions and using the cPCH test for multiple PCH testing.

2. `cpch_source.py`: This script contains general cPCH testing functions that are not example-specific, including the main function called in all every `_sim.py` file and `code_tutorial.ipynb` to compute cPCH p-values: `cpch()`.

3. `reproducibility`: this directory contains all scripts necessary for reproducing the data and figures presented in the paper. It contains the following directories and files:

     - `mpch_cpch_comparisons.R`: reproduces the figure comparing the Max-P, mPCH and cPCH Type I error and power in the *Motivation and Intuition* section of the paper.

     - `single_pch`: This directory contains two Python scripts, `single_pch_sim.py` and `robustness_sim.py`, for reproducing the Type I error and power simulations comparing the cPCH test with standard PCH tests and the robustness simulation study respectively. Both scripts were run on a computing cluster 5000 times for each configuration presented in the Simulations section of the paper. `single_pch_plotting.R` reproduces the exact plots from the paper, once you have run `single_pch_sim.py` and `robustness_sim.py` respectively 5000 times for each configuration presented in the paper and saved the output. We provide a sample `submit.sh` and `batch.sh` file for running the `single_pch_sim.py` script on all configurations presented in the paper on Harvard University's high-performance computing cluster from 2023-2024 using a Slurm Workload Manager. More details on the computing cluster can be found here: https://www.rc.fas.harvard.edu/.

     - `multiple_pch`: This directory contains `multiple_pch_sim.py` and `mt_covariates_sim.R`, for reproducing the first and second multiple PCH testing examples described in the paper respectively. `compile_csvs_mt_pch.R` and `compile_csvs_mt_cov.R` compiles the csv output of `multiple_pch_sim.py` and `mt_covariates_sim.R` respectively. Both scripts were run on a computing cluster 1000 times for each configuration presented in the Multiple PCH Testing section of the paper. `multiple_pch_sim_plotting.R` and `mt_cov_plotting.R` reproduces the exact plots from the paper, once you have run `multiple_pch_sim.py` and `mt_covariates_sim.R` respectively 1000 times for each configuration presented in the paper, saved the output, and run their respective compile csv scripts to get the final .csv file. We provide a sample `submit_mt.sh` and `batch_mt.sh` file for running the `multiple_pch_sim.py` script on all configurations presented in the paper on Harvard University's high-performance computing cluster from 2023-2024 using a Slurm Workload Manager. More details on the computing cluster can be found here: https://www.rc.fas.harvard.edu/.

     - `DMD`: This directory contains `DMD_data_processing.R`, which preprocesses the DMD data used in the real data example of the paper. This script borrows heavily from preprocessing code provided by Jingshu Wang. `gds563.rda`, `gds214.rda`, `gds3027.rda`, and `gds1956.rda` contain the data for the four microarray studies (GDS214, GDS563, GDS1956, and GDS3027) used in the paper. `GPL246_annot.csv`, `GPL8300_annot.csv`, `GPL96_annot.csv` contain gene annotations for the genes tested in the studies. The original data can be downloaded from the Gene Expression Omnibus (GEO) database, a public functional genomics data repository. `DMD_get_pch_pvals.ipynb` reproduces the single PCH testing results presented in the Differential Gene Expression Analysis section of the paper.`DMD_run_pch_mt.ipynb` reproduces the multiple PCH testing presented in the Differential Gene Expression Analysis section of the paper.

    - `lookup_table`: This directory contains scripts necessary to generate the lookup table described in Section 4.2 of the paper. We provide sample `submit_lookup.sh` and `batch_lookup.sh` files for running the `generate_lookup.py` script on Harvard University's high-performance computing cluster from 2023-24 using a Slurm Workload Manager. More details on the computing cluster can be found here: https://www.rc.fas.harvard.edu/.

    - `Supplementary_Materials`: This directory contains various scripts needed to reproduce results contained in the Supplementary Materials of the paper. In particular, the `validity` directory contains two IPython Notebooks for reproducing the results presented in the the *Approximate Validity* section of the paper: `validity_sim.ipynb`, which generates the data used for the qq-plots and K-S distance plots.  `valid_plotting.R` reproduces the figures presented the paper. The scripts `eb_appendix_t1err.R` and `eb_appendix_mt.R` can be used to reproduce the tables of Appendix C.2.6. These scripts were run on Harvard University's high-performance computing cluster from 2023-2024. More details on the computing cluster can be found here: https://www.rc.fas.harvard.edu/.
